<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!--Favicon set-->
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="https://s3.amazonaws.com/sachinreddy.com/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://s3.amazonaws.com/sachinreddy.com/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://s3.amazonaws.com/sachinreddy.com/favicon-16x16.png"
      sizes="16x16"
    />
    <link
      rel="manifest"
      href="https://s3.amazonaws.com/sachinreddy.com/manifest.json"
    />
    <link
      rel="mask-icon"
      href="https://s3.amazonaws.com/sachinreddy.com/safari-pinned-tab.svg"
      color="#5bbad5"
    />
    <meta name="theme-color" content="#ffffff" />

    <!-- Title and Author -->
    <title>Sachin Reddy</title>
    <meta name="author" content="Sachin Reddy" />
    <meta
      name="description"
      content="Software Engineer, Web Enthusiast, Movie Addict"
    />

    <!-- Social Graph Construction -->
    <meta property="og:title" content="Sachin Reddy" />
    <meta property="og:url" content="sachinreddy.com/" />
    <meta property="og:site_name" content="Sachin Reddy" />
    <meta
      property="og:description"
      content="Software Engineer, Web Enthusiast, Movie Addict"
    />
    <meta
      property="og:image"
      content="https://s3.amazonaws.com/sachinreddy.com/assets/image/profile.webp"
    />
    <meta property="og:type" content="blog" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta
      name="twitter:description"
      content="Software Engineer, Web Enthusiast, Movie Addict"
    />
    <meta name="twitter:title" content="Sachin Reddy" />
    <meta name="twitter:url" content="sachinreddy.com/" />
    <meta name="twitter:site" content="Sachin Reddy" />
    <meta name="twitter:creator" content="@https://twitter.com/sachinreddy9" />
    <meta name="twitter:domain" content="sachinreddy.com" />
    <meta
      property="twitter:image"
      content="https://s3.amazonaws.com/sachinreddy.com/assets/image/profile.webp"
    />

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Inconsolata|Lora|Space+Mono:700"
    />

    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
      integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://s3.amazonaws.com/sachinreddy.com/assets/stateface.css"
    />

    <!-- CSS -->
    <!-- <link rel="stylesheet" href="css/main.css"> -->
    <link
      rel="stylesheet"
      href="https://s3.amazonaws.com/sachinreddy.com/css/main.css"
    />

    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/octicons/2.0.2/octicons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.rawgit.com/konpa/devicon/4f6a4b08efdad6bb29f9cc801f5c07e263b39907/devicon.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.rawgit.com/konpa/devicon/df6431e323547add1b4cf45992913f15286456d3/devicon.min.css"
    />

    <link
      rel="alternate"
      type="application/rss+xml"
      title="Sachin Reddy"
      href="sachinreddy.com/feed.xml"
    />
    <link rel="canonical" href="sachinreddy.com/GeometricAcoustics/" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-143028700-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-143028700-1");
    </script>
  </head>

  <body>
    <main>
      <article
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <header class="section-padding--lg mast">
          <a class="nav nav--white" href="/">
            <i class="fa fa-lg fa-arrow-left"></i>
            <span>Back</span>
          </a>

          <figure
            class="absolute-bg mast__img"
            style="background-image: url('https://s3.amazonaws.com/sachinreddy.com/assets/image/GeometricAcoustics/GeometricAcousticsCover.png');"
          ></figure>

          <div class="mast__container">
            <h1 itemprop="name headline">Geometric Acoustics</h1>
          </div>
        </header>

        <section class="section-padding post" itemprop="articleBody">
          <div class="markdown-body">
                
        <span class="hljs-comment">// Additional bounces</span>
        Int3 lastHitBlock = Int3.create(rayHit.getBlockPos().getX(), rayHit.getBlockPos().getY(), rayHit.getBlockPos().getZ());
        Vec3d lastHitPos = rayHit.hitVec;
        <span class="hljs-comment">// For reflecting</span>
        Vec3d lastHitNormal = getNormalFromFacing(rayHit.sideHit);
        Vec3d lastRayDir = rayDir;
                
        <span class="hljs-keyword">float</span> totalRayDistance = (<span class="hljs-keyword">float</span>)rayLength;
                
        <span class="hljs-comment">//Secondary ray bounces</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; rayBounces; j++)
        {
            Vec3d newRayDir = reflect(lastRayDir, lastHitNormal);
            Vec3d newRayStart = <span class="hljs-keyword">new</span> Vec3d(lastHitPos.xCoord + lastHitNormal.xCoord * <span class="hljs-number">0.01</span>, lastHitPos.yCoord + lastHitNormal.yCoord * <span class="hljs-number">0.01</span>, lastHitPos.zCoord + lastHitNormal.zCoord * <span class="hljs-number">0.01</span>);
            Vec3d newRayEnd = <span class="hljs-keyword">new</span> Vec3d(newRayStart.xCoord + newRayDir.xCoord * maxDistance, newRayStart.yCoord + newRayDir.yCoord * maxDistance, newRayStart.zCoord + newRayDir.zCoord * maxDistance);                 
            RayTraceResult newRayHit = minecraft.theWorld.rayTraceBlocks(newRayStart, newRayEnd, <span class="hljs-keyword">true</span>);
                                                
            <span class="hljs-keyword">if</span> (newRayHit != <span class="hljs-keyword">null</span>)
            {   
                <span class="hljs-keyword">double</span> newRayLength = lastHitPos.distanceTo(newRayHit.hitVec);
                totalRayDistance += newRayLength;
                
                lastHitPos = newRayHit.hitVec;
                lastHitNormal = getNormalFromFacing(newRayHit.sideHit);
            }
            <span class="hljs-keyword">else</span>
                totalRayDistance += lastHitPos.distanceTo(playerPos);
                    
            <span class="hljs-keyword">if</span> (newRayHit == <span class="hljs-keyword">null</span>)
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre></div></div>
<p class="has-line-data" data-line-start="137" data-line-end="138">And with this, I can then add various calculations to modify the Gain and Cutoff values that will be used for modifying the filters!</p>
<h3 class="code-line" data-line-start=139 data-line-end=140 ><a id="Realtime_Reverberation_139"></a>Real-time Reverberation</h3>
<p class="has-line-data" data-line-start="140" data-line-end="141">Now that I am able to calculate the environment using raytracing. I can then use the calculated values to modify the Gain and Cutoff values. With reverberation, I mainly need to modify the Gain.</p>
<p class="has-line-data" data-line-start="142" data-line-end="143">In the raytracing of the environement, I calculate the energy towards the player with the block reflectivity. Block reflectivity is a preset value that I estimated at the start. For example:</p>
<div class="language-java highlighter-rouge">
  <div class="highlight">
    <pre
      class="highlight"
    ><code class="has-line-data" data-line-start="145" data-line-end="151" class="language-java"><span class="hljs-keyword">if</span> (soundType == SoundType.STONE)
    reflectivity = <span class="hljs-number">1.0</span>;
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (soundType == SoundType.WOOD)
    reflectivity = <span class="hljs-number">0.5</span>;
...
</code></pre></div></div>
<p class="has-line-data" data-line-start="152" data-line-end="153">Various calculation were added to ensure a good sound for reverberation. If you want to look into all the calculations done, check out the code on my <a href="https://github.com/sachinreddy1/Geometric_Acoustics/blob/master/src/main/java/com/sachinreddy/GeometricAcoustics/GeometricAcoustics.java">Github</a>.</p>
<h3 class="code-line" data-line-start=154 data-line-end=155 ><a id="Realtime_Occlusion_154"></a>Real-time Occlusion</h3>
<p class="has-line-data" data-line-start="156" data-line-end="157"><img src="https://s3.amazonaws.com/sachinreddy.com/GeometricAcoustics/Occlusion.png" style="display: block;margin: auto; width: 50%;" alt="Occlusion" title="Occlusion"></p>
<p class="has-line-data" data-line-start="158" data-line-end="159">Consider the image above. Any sounds that pass from source to listener must pass through the wall, which muffles the sounds. This is called occlusion.</p>
<p class="has-line-data" data-line-start="160" data-line-end="161">To implement occlusion, I had to accumulate the amount of obstruction between the player and the sound source. This was done by drawing a ray from the sound’s position to the player’s position. If the ray happened to hit a block along its path, an occlusion accumulation value was summed along with a block occlusion value.</p>
<p class="has-line-data" data-line-start="162" data-line-end="163">By using:</p>
<div class="language-java highlighter-rouge">
  <div class="highlight">
    <pre
      class="highlight"
    ><code class="has-line-data" data-line-start="164" data-line-end="166" class="language-java"><span class="hljs-keyword">if</span> (!blockHit.isOpaqueCube(blockHit.getDefaultState()))
</code></pre></div></div>
<p class="has-line-data" data-line-start="166" data-line-end="167">I was able check if the block hit was opaque. If not, my block occlusion value would be decreased.</p>
<p class="has-line-data" data-line-start="168" data-line-end="169">The full occlusion code is given here:</p>
<div class="language-java highlighter-rouge">
  <div class="highlight">
    <pre
      class="highlight"
    ><code class="has-line-data" data-line-start="170" data-line-end="197" class="language-java">soundPos = offsetSoundByName(soundPos, playerPos, lastSoundName, lastSoundCategory.getName());
Vec3d toPlayerVector = playerPos.subtract(soundPos).normalize();

<span class="hljs-comment">// Offset the ray start position towards the player by the diagonal half length of a cube</span>
Vec3d rayOrigin = <span class="hljs-keyword">new</span> Vec3d(soundPos.xCoord, soundPos.yCoord, soundPos.zCoord);
<span class="hljs-keyword">if</span> (lastSoundName.matches(<span class="hljs-string">".*block.*"</span>))
    rayOrigin = rayOrigin.add(toPlayerVector.scale(<span class="hljs-number">0.867</span>));

<span class="hljs-keyword">float</span> occlusionAccumulation = <span class="hljs-number">0.0f</span>;     
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
    RayTraceResult rayHit = minecraft.theWorld.rayTraceBlocks(rayOrigin, playerPos, <span class="hljs-keyword">true</span>);
    
    <span class="hljs-keyword">if</span> (rayHit != <span class="hljs-keyword">null</span>) {
        Block blockHit = minecraft.theWorld.getBlockState(rayHit.getBlockPos()).getBlock();
        <span class="hljs-keyword">float</span> blockOcclusion = <span class="hljs-number">1.0f</span>;
        
        <span class="hljs-keyword">if</span> (!blockHit.isOpaqueCube(blockHit.getDefaultState()))
            blockOcclusion *= <span class="hljs-number">0.15f</span>;
        
        occlusionAccumulation += blockOcclusion;
        
        rayOrigin = <span class="hljs-keyword">new</span> Vec3d(rayHit.hitVec.xCoord + toPlayerVector.xCoord * <span class="hljs-number">0.1</span>, rayHit.hitVec.yCoord + toPlayerVector.yCoord * <span class="hljs-number">0.1</span>, rayHit.hitVec.zCoord + toPlayerVector.zCoord * <span class="hljs-number">0.1</span>);
    }
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">break</span>;
}
</code></pre></div></div>
<p class="has-line-data" data-line-start="197" data-line-end="198">With this, real-time occlusion was implemented by using the occlusion accumulation along with setting Gain and Cutoff values.</p>
<h3 class="code-line" data-line-start=199 data-line-end=200 ><a id="Visualizing_Raytraces_in_GUI_199"></a>Visualizing Raytraces in GUI</h3>
<p class="has-line-data" data-line-start="200" data-line-end="201">Aside from getting good sounding reverberation in the mod. I felt it necessary to add an overlay GUI to the game so that users could visualize the sound source’s raytraces in their given environment.</p>
<p class="has-line-data" data-line-start="202" data-line-end="203">Simple rendering of textures was done by adding sprites to the resources folder and calling the following code:</p>
<div class="language-java highlighter-rouge">
  <div class="highlight">
    <pre
      class="highlight"
    ><code class="has-line-data" data-line-start="205" data-line-end="215" class="language-java">ResourceLocation histogramBlock = <span class="hljs-keyword">new</span> ResourceLocation(GeometricAcousticsCore.modid, <span class="hljs-string">"textures/gui/histogram.png"</span>);

GL11.glPushMatrix();
{
    GL11.glColor3f(r, g, b);
    mc.renderEngine.bindTexture(histogramBlock);
    drawTexturedModalRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);
}
GL11.glPopMatrix();
</code></pre></div></div>
<p class="has-line-data" data-line-start="215" data-line-end="216">OpenGL (GL11) can be used to transform the texture in many different ways. In the above example, I am able to modify the color of the texture to any given RGB value.</p>
<p class="has-line-data" data-line-start="217" data-line-end="218">Players will <strong>press F6</strong> to see the GUI. An example of the finished overlay is pictured here:</p>
<p class="has-line-data" data-line-start="219" data-line-end="220"><img src="https://s3.amazonaws.com/sachinreddy.com/GeometricAcoustics/GuiOverlay.png" alt="GUI Overlay" title="GUI Overlay"></p>

<h3 class="code-line" data-line-start=222 data-line-end=223 ><a id="Stereo_Sound_222"></a>Stereo Sound</h3>
<p class="has-line-data" data-line-start="224" data-line-end="225">Currently Minecraft does not support multi-channel audio, so I decided to add stereo sound to all reverberation in the game. This way, the player will feel much more immersed.</p>
<p class="has-line-data" data-line-start="226" data-line-end="227">To do this, I used the effects AL_EAXREVERB_LATE_REVERB_PAN and AL_EAXREVERB_REFLECTIONS_PAN. Inputting a vector such as [-1.0f, 0.0f, 0.0f] would give reverberation entirely in the left ear. Building on top of this, I implemented a dynamic way to set the pan’s position parameters.</p>
<p class="has-line-data" data-line-start="228" data-line-end="229">For each bounce of the emitted ray trace, I accumulate the x-position in an array indexed by the ray bounce. See the figure:</p>
<p class="has-line-data" data-line-start="230" data-line-end="231"><img src="https://s3.amazonaws.com/sachinreddy.com/GeometricAcoustics/StereoSound.png" style="display: block;margin: auto; width: 50%;" alt="Stereo Sound" title="Stereo Sound"></p>
<p class="has-line-data" data-line-start="232" data-line-end="233">After these values are accumulated, they are then normalized, clamped between -1.0f and 1.0f, and attached to the effect object.</p>
<p class="has-line-data" data-line-start="234" data-line-end="235">Although simple, this method allows for varying reverberation in each ear. Further implementation could be done to support surround sound.</p>

<h3 class="code-line" data-line-start=221 data-line-end=222 ><a id="Conclusion_221"></a>Conclusion</h3>
<p class="has-line-data" data-line-start="222" data-line-end="223">Overall I really enjoyed this project, since it applied game engine techniques including raytracing and OpenAL modifications. I plan on updating the code considering that new versions of Minecraft continue to be released and my code only supports version 1.11.</p>
<p class="has-line-data" data-line-start="224" data-line-end="226"><a href="GeometricAcoustics-1.11.jar">Download (Version 1.11)</a><br>
<a href="https://github.com/sachinreddy1/Geometric_Acoustics">Link to Github Repo</a></p>
          </div>
        </section>
      </article>
    </main>

    <!-- Github Activity -->
    <div id="gh-wrapper">
      <div id="feed"></div>
      <div id="gh-button">Github Activity</div>
    </div>

    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://s3.amazonaws.com/sachinreddy.com/assets/js/github-activity.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://s3.amazonaws.com/sachinreddy.com/assets/js/bundles.js"
    ></script>
  </body>
</html>
